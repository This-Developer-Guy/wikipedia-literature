<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Wikipedia Literature Checker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
            color: #111;
            transition: background 0.3s, color 0.3s;
        }
        
        body.dark {
            background: #1e1e1e;
            color: #ddd;
        }
        
        h1 {
            text-align: center;
        }
        
        #controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        label {
            margin-right: 10px;
        }
        
        input,
        select {
            margin-right: 20px;
        }
        
        button {
            padding: 6px 12px;
            cursor: pointer;
        }
        
        #progress-container {
            width: 80%;
            margin: 10px auto;
            background: #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 20px;
        }
        
        #progress-bar {
            height: 100%;
            width: 0;
            background: #4caf50;
            transition: width 0.2s;
        }
        
        #results {
            margin-top: 20px;
        }
        
        .article {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        body.dark .article {
            background: #2a2a2a;
            box-shadow: 0 2px 5px rgba(255, 255, 255, 0.05);
        }
        
        .entry {
            margin-left: 20px;
            padding: 5px;
            border-left: 2px solid #ddd;
        }
        
        .isbns {
            color: green;
        }
        
        .no-isbn {
            color: red;
        }
        
        .warning {
            color: orange;
        }
        
        details {
            margin-top: 5px;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        mark {
            background: yellow;
            color: black;
        }
        
        body.dark mark {
            background: gold;
            color: black;
        }
    </style>
</head>

<body>
    <h1>Wikipedia Literature Checker</h1>
    <div id="controls">
        <label>Topic: <input type="text" id="topic" value="Antike"></label>
        <label>Max articles: <input type="number" id="maxArticles" value="20" min="1" max="250"></label>
        <label>Mode:
      <select id="mode" onchange="toggleRegexInput(); toggleISBNInput()">
        <option value="normal">Missing ISBN</option>
        <option value="title">Title checker</option>
        <option value="isbn">ISBN checker</option>
        <option value="editor">Editor checker</option>
        <option value="in-style">"In" Style</option>
        <option value="year-range">Invalid Range</option>
        <option value="regex">Custom regex</option>
      </select>
    </label>
        <span id="regex-container" style="display:none">
      <label>Pattern: <input type="text" id="regexPattern" placeholder="e.g. 202\\d"></label>
      <label><input type="checkbox" id="regexWhole"> Whole article</label>
    </span>
        <span id="isbn-container" style="display:inline">
            <label><input type="checkbox" id="suggestIsbn" onchange="setISBNMode();" checked> Suggest ISBN</label>
            <select id="isbn-mode">
            </select>
        </span>
        <button onclick="startRun()">Run</button>
        <button onclick="toggleDarkMode()">üåô/‚òÄÔ∏è</button>
    </div>

    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <div id="results"></div>

    <script>
        (async() => {
            toggleISBNInput();
            const module = await
            import ('./catalogue-query-api/module.js');
            window.module = module;

            function populateISBNSelect() {
                const select = document.getElementById('isbn-mode');
                if (!select) return;

                const combinations = window.module.getAllProviderCombinations();

                select.innerHTML = '';

                combinations.forEach(combo => {
                    const option = document.createElement('option');
                    option.value = combo.id;
                    option.textContent = combo.name;
                    select.appendChild(option);
                });

                const savedIsbnMode = localStorage.getItem('isbnMode');
                if (savedIsbnMode) {
                    select.value = savedIsbnMode;
                }
            }

            populateISBNSelect();

            function restoreSettings() {
                const topic = localStorage.getItem('topic');
                if (topic) document.getElementById('topic').value = topic;

                const maxArticles = localStorage.getItem('maxArticles');
                if (maxArticles) document.getElementById('maxArticles').value = maxArticles;

                const mode = localStorage.getItem('mode');
                if (mode) {
                    document.getElementById('mode').value = mode;
                    toggleRegexInput();
                    toggleISBNInput();
                }

                const regexPattern = localStorage.getItem('regexPattern');
                if (regexPattern) document.getElementById('regexPattern').value = regexPattern;

                const regexWhole = localStorage.getItem('regexWhole');
                if (regexWhole) document.getElementById('regexWhole').checked = (regexWhole === 'true');

                const suggestIsbn = localStorage.getItem('suggestIsbn');
                if (suggestIsbn) {
                    document.getElementById('suggestIsbn').checked = (suggestIsbn === 'true');
                }

                setISBNMode();

                const isbnMode = localStorage.getItem('isbnMode');
                if (isbnMode) {
                    const isbnSelect = document.getElementById('isbn-mode');
                    if (isbnSelect) isbnSelect.value = isbnMode;
                }
            }

            restoreSettings();

            function saveSetting(key, value) {
                localStorage.setItem(key, value);
            }

            document.getElementById('topic').addEventListener('input', e => saveSetting('topic', e.target.value));
            document.getElementById('maxArticles').addEventListener('input', e => saveSetting('maxArticles', e.target.value));
            document.getElementById('mode').addEventListener('change', e => {
                saveSetting('mode', e.target.value);
                toggleRegexInput();
                toggleISBNInput();
            });
            document.getElementById('regexPattern').addEventListener('input', e => saveSetting('regexPattern', e.target.value));
            document.getElementById('regexWhole').addEventListener('change', e => saveSetting('regexWhole', e.target.checked));
            document.getElementById('suggestIsbn').addEventListener('change', e => {
                saveSetting('suggestIsbn', e.target.checked);
                setISBNMode();
            });
            document.getElementById('isbn-mode').addEventListener('change', e => saveSetting('isbnMode', e.target.value));
        })();

        // Dark mode init
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark");
        }

        function toggleRegexInput() {
            const mode = document.getElementById("mode").value;
            document.getElementById("regex-container").style.display = (mode === "regex") ? "inline" : "none";
        }

        function toggleISBNInput() {
            const mode = document.getElementById("mode").value;
            document.getElementById("isbn-container").style.display = (mode === "normal") ? "inline" : "none";
        }

        function isSuggestIsbnOn() {
            const el = document.getElementById("suggestIsbn");
            return !!(el && el.checked);
        }

        function setISBNMode() {
            let isbn_mode = document.getElementById("isbn-mode");
            if (isSuggestIsbnOn()) {
                isbn_mode.disabled = false;
            } else {
                isbn_mode.disabled = true;
            }
        }

        function allIsbnsRequireDotBeforeWithLocations(str) {
            const re = /([^\s])?\s*ISBN/ig;
            const failures = [];
            let foundAny = false;
            for (const m of str.matchAll(re)) {
                foundAny = true;
                const ch = m[1];
                if (ch === '.') {
                    const charPos = m.index;
                    failures.push({
                        index: charPos,
                        foundChar: ch,
                        context: str.slice(Math.max(0, charPos - 20), Math.min(str.length, charPos + 40))
                    });
                }
            }
            return {
                foundAny,
                failures
            };
        }

        function cleanTrailing(str) {
            return str.replace(/[.,|f]+$/g, "");
        }

        async function fetchArticlesByTopic(topic, maxArticles, mode) {
            const searchUrl = `https://de.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(topic)}&format=json&origin=*&srlimit=${maxArticles}`;
            const searchResp = await fetch(searchUrl);
            if (!searchResp.ok) throw new Error("Wikipedia search failed");
            const searchData = await searchResp.json();
            const titles = searchData.query.search.map(s => s.title);

            const results = [];
            const progressBar = document.getElementById("progress-bar");

            for (let i = 0; i < titles.length; i++) {
                const title = titles[i];
                const articleUrl = `https://de.wikipedia.org/w/api.php?action=query&prop=revisions&rvprop=content&format=json&titles=${encodeURIComponent(title)}&origin=*`;
                const articleResp = await fetch(articleUrl);
                if (!articleResp.ok) continue;
                const articleData = await articleResp.json();
                const page = Object.values(articleData.query.pages)[0];
                if (!page || !page.revisions) continue;
                const content = page.revisions[0]['*'];
                if (!content) continue;

                const litHeaderMatch = content.match(/(^|\n)==+\s*(Literatur|Literaturhinweise|Literatur und Quellen)\s*==+/i);
                if (!litHeaderMatch && mode !== "regex") continue;

                let literatureEntries = [];
                if (litHeaderMatch) {
                    let sectionStart = litHeaderMatch.index + litHeaderMatch[0].length;
                    let rest = content.substring(sectionStart);
                    let nextSectionMatch = rest.search(/\n==+/);
                    if (nextSectionMatch !== -1) rest = rest.substring(0, nextSectionMatch);
                    const lines = rest.split('\n').map(l => l.trim());
                    literatureEntries = lines.filter(l => l.startsWith('*')).map(l => l.replace(/^\*\s*/, '').trim());
                }

                const entryResults = [];

                for (const entry of literatureEntries) {
                    let extractedTitle = null;
                    let extractedYear = null;
                    const yearMatchRegex = /\s(\d{4})([f.,\s\/\|])/g;
                    const yearMatch = entry.match(yearMatchRegex);
                    const quoteMatch = entry.match(/['\u2018\u2019\u201C\u201D"]([^'"\u2018\u2019\u201C\u201D]{3,}?)['\u2018\u2019\u201C\u201D"]/);
                    if (quoteMatch) extractedTitle = quoteMatch[1].trim();
                    else {
                        const beforeColon = entry.split(':')[0];
                        if (beforeColon && beforeColon.length > 3) extractedTitle = beforeColon.trim();
                    }

                    if (yearMatch) {
                        extractedYear = cleanTrailing(yearMatch[0].trim());
                    }

                    let warnings = [];
                    let hasHit = false;

                    if (mode === "title") {
                        if (entry.includes("''.")) {
                            warnings.push("Contains '' before a dot");
                            hasHit = true;
                        }
                    } else if (mode === "editor") {
                        let regex = /\(([Hh]g|hrsg)\.?\)/;
                        let match = entry.match(regex);
                        if (match != null) {
                            warnings.push(`Found ${match[0]}`);
                            hasHit = true;
                        }
                    } else if (mode === "in-style") {
                        let regex_in = /\sin[,.:]/;
                        let regex_punct = /\s[Ii]n[,.]/;
                        let match_in = entry.match(regex_in);
                        let match_punct = entry.match(regex_punct);
                        if (match_in != null) {
                            warnings.push("Contains 'in' instead of 'In'");
                            hasHit = true;
                        }
                        if (match_punct != null) {
                            warnings.push("Contains incorrect punctuation after");
                            hasHit = true;
                        }
                    } else if (mode === "year-range") {
                        let regex = /\b(1[0-9]{3}|20[0-4][0-9]|2050)\s*-\s*(1[0-9]{3}|20[0-4][0-9]|2050)\b(?![-\d])/;
                        let match = entry.match(regex);
                        if (match != null) {
                            warnings.push(`Found year range without Dash`);
                            hasHit = true;
                        }
                    } else if (mode === "isbn") {
                        const check = allIsbnsRequireDotBeforeWithLocations(entry);
                        if (check.foundAny && check.failures.length > 0) {
                            hasHit = true;
                            warnings.push("Dot before ISBN found at positions: " + check.failures.map(f => f.index).join(", "));
                        }
                    } else if (mode === "regex" && !document.getElementById("regexWhole").checked) {
                        const pattern = document.getElementById("regexPattern").value;
                        if (pattern) {
                            try {
                                const regex = new RegExp(pattern, "i");
                                if (regex.test(entry)) {
                                    warnings.push("Matched custom regex");
                                    hasHit = true;
                                }
                            } catch (e) {
                                console.warn("Invalid regex:", e);
                            }
                        }
                    }

                    if (mode === "normal" && !entry.includes("ISBN") && extractedTitle) {
                        let isbns = [];
                        if (isSuggestIsbnOn()) {
                            try {
                                const isbnMode = document.getElementById("isbn-mode").value;
                                const out = await window.module.queryDBISBN(isbnMode, extractedTitle, extractedYear);
                                let combined = null;
                                if (out && out.combined) {
                                    combined = out.combined;
                                }
                                if (Array.isArray(combined)) {
                                    isbns = combined;
                                } else if (combined && combined.isbns) {
                                    isbns = combined.isbns;
                                }
                            } catch (e) {
                                console.warn("ISBN suggestion failed:", e);
                            }
                        }
                        entryResults.push({
                            entry,
                            extractedTitle,
                            isbns,
                            warnings
                        });
                    } else if (mode !== "normal" && hasHit) {
                        entryResults.push({
                            entry,
                            extractedTitle,
                            isbns: [],
                            warnings
                        });
                    }
                }

                // whole article regex mode
                if (mode === "regex" && document.getElementById("regexWhole").checked) {
                    const pattern = document.getElementById("regexPattern").value;
                    if (pattern) {
                        try {
                            const regex = new RegExp(pattern, "gi");
                            const matches = [];
                            for (const m of content.matchAll(regex)) {
                                const start = Math.max(0, m.index - 40);
                                const end = Math.min(content.length, m.index + m[0].length + 40);
                                const context = content.slice(start, end).replace(/\n/g, " ");
                                const highlighted = context.replace(m[0], `<mark>${m[0]}</mark>`);
                                matches.push("..." + highlighted + "...");
                            }
                            if (matches.length > 0) {
                                entryResults.push({
                                    entry: "(whole article matched)",
                                    extractedTitle: null,
                                    isbns: [],
                                    warnings: ["Matched custom regex in whole article"],
                                    matches
                                });
                            }
                        } catch (e) {
                            console.warn("Invalid regex:", e);
                        }
                    }
                }

                if (entryResults.length > 0) {
                    results.push({
                        title,
                        entries: entryResults
                    });
                }

                progressBar.style.width = (((i + 1) / titles.length) * 100) + "%";
            }
            return results;
        }

        async function startRun() {
            const topic = document.getElementById("topic").value;
            const maxArticles = parseInt(document.getElementById("maxArticles").value);
            const mode = document.getElementById("mode").value;
            const resultsDiv = document.getElementById("results");
            document.getElementById("progress-bar").style.width = "0%";
            resultsDiv.innerHTML = `<p>Fetching articles for <b>${topic}</b>...</p>`;

            try {
                const results = await fetchArticlesByTopic(topic, maxArticles, mode);
                resultsDiv.innerHTML = "";
                results.forEach(art => {
                    const artDiv = document.createElement("div");
                    artDiv.className = "article";
                    artDiv.innerHTML = `<a href="${"https://de.wikipedia.org/wiki/" + art.title.replace(" ", "_")}"><h3>${art.title}</h3></a>`;
                    art.entries.forEach((e, idx) => {
                        const entryDiv = document.createElement("div");
                        entryDiv.className = "entry";
                        const isbnInfo = e.isbns.length > 0 ?
                            `<span class='isbns'>ISBNs: ${e.isbns.join(", ")}</span>` :
                            (mode === "normal" ? `<span class='no-isbn'>(no ISBNs found)</span>` : "");
                        const warningInfo = e.warnings.length > 0 ? `<div class='warning'>‚ö† ${e.warnings.join("; ")}</div>` : "";
                        const matchesInfo = e.matches && e.matches.length > 0 ?
                            `<div class='warning'>Matches:<pre>${e.matches.join("\n---\n")}</pre></div>` :
                            "";
                        entryDiv.innerHTML = `
                <details>
                  <summary>[${idx + 1}] ${e.extractedTitle || "(no title)"} ${(mode === "normal" && isSuggestIsbnOn()) ? "‚Äî " + isbnInfo : ""}</summary>
                  ${warningInfo}
                  ${matchesInfo}
                  <pre>${e.entry}</pre>
                </details>`;
                        artDiv.appendChild(entryDiv);
                    });
                    resultsDiv.appendChild(artDiv);
                });
            } catch (e) {
                resultsDiv.innerHTML = `<p style='color:red'>Error: ${e.message}</p>`;
            }
        }
    </script>
</body>

</html>
